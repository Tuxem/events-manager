{% extends "base.html" %}

{% block body %}
<h1>{{ 'Edit' if event.id else 'Create' }} Event</h1>

<form method="post">
    {{ form.hidden_tag() }}
    <div class="mb-3">
        <label for="date" class="form-label">Date:</label>
        <input type="date" class="form-control" id="date" name="date" value="{{ event_date if event_date else '' }}" required>
    </div>

    <div class="mb-3">
        <label for="place_id" class="form-label">Place:</label>
        <select class="form-control" id="place_id" name="place_id">
            {% for place in places %}
            <option value="{{ place.id }}" {% if event.place_id == place.id %} selected {% endif %}>{{ place.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="band_ids" class="form-label">Select Bands:</label>
        <select class="form-control" id="band_ids" name="band_ids[]" multiple="multiple">
            {% for band in bands %}
            <option value="{{ band.id }}" {% if band.id in event_band_ids %} selected {% endif %}>{{ band.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Running Order:</label>
        <ul id="sorted_bands" class="list-group sortable">
            {% for event_band in event_bands %}
            <li class="list-group-item" data-id="{{ event_band.band_id }}">
                {{ event_band.band.name }}
                <input type="hidden" name="band_ids[]" value="{{ event_band.band_id }}">
                <input type="hidden" name="band_order[]" value="{{ event_band.order }}">
            </li>
            {% endfor %}
        </ul>
    </div>

    <button type="submit" class="btn btn-primary">{{ 'Update' if event.id else 'Create' }}</button>
</form>

<link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    var $select = $('#band_ids').select2({
        placeholder: "Select bands",
        allowClear: true
    });

    // Initialize sortable list for selected bands
    $('#sorted_bands').sortable({
        placeholder: "ui-state-highlight",
        update: function(event, ui) {
            updateBandOrder();
        }
    });

    // Disable selection to avoid unwanted text selection during drag
    $('#sorted_bands').disableSelection();

    // Function to update hidden inputs based on the current order in the sorted list
    function updateBandOrder() {
        var order = [];
        $('#sorted_bands li').each(function(index) {
            order.push($(this).data('id')); // Assuming data-id holds the band ID
            $(this).find('input[name="band_order[]"]').val(index);
        });

        console.log('Order before sorting:', order);
        console.log('Hidden inputs updated.');
    }

    // Initialize band order on load
    updateBandOrder();
});
</script>
{% endblock %}
